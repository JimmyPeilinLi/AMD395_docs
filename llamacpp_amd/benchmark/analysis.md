# llama.cpp 性能测试报告

## 测试环境

| 项目 | 规格 |
|------|------|
| **CPU** | AMD Ryzen AI MAX+ 395 (16C/32T, Zen 5) |
| **GPU** | AMD Radeon 8060S (gfx1151, 40 CUs, RDNA 3.5) |
| **内存** | 128GB LPDDR5X (统一内存架构) |
| **GPU 可用内存** | ~95GB (64GB VRAM + 31GB GTT) |
| **操作系统** | Ubuntu 24.04 LTS |
| **内核** | 6.11.0-17-generic |
| **llama.cpp** | build 7709 (Vulkan 后端) |

## 测试模型

| 模型 | 量化格式 | 大小 | 精度 |
|------|----------|------|------|
| Qwen3-30B-A3B | Q4_K_M | 17.28 GB | 4-bit 量化 |
| Qwen3-30B-A3B | F16 | 56.89 GB | 16-bit 浮点 |

---

## Q4_K_M vs F16 性能对比 (2026-01-15)

### Prefill 速度 (tokens/s)

| Prompt 长度 | Q4_K_M | F16 | Q4_K_M/F16 |
|-------------|--------|-----|------------|
| 128 tokens | **498** | 269 | 1.85x |
| 512 tokens | **1004** | 640 | 1.57x |
| 1024 tokens | **906** | 613 | 1.48x |
| 2048 tokens | **811** | 589 | 1.38x |

### Decode 速度 (tokens/s)

| 生成长度 | Q4_K_M | F16 | Q4_K_M/F16 |
|----------|--------|-----|------------|
| 128 tokens | **86.0** | 21.9 | 3.93x |
| 256 tokens | **85.8** | 21.9 | 3.92x |

### 关键发现

1. **Q4_K_M 在所有场景下都更快**
   - Prefill: 1.4x - 1.9x 更快
   - Decode: ~4x 更快

2. **内存效率**
   - Q4_K_M: 17GB (可在 64GB VRAM 中轻松运行)
   - F16: 57GB (接近 64GB VRAM 上限)

3. **精度 vs 速度权衡**
   - F16 保留完整精度，适合对准确性要求高的场景
   - Q4_K_M 速度优势明显，推荐日常使用

---

## GPU vs CPU 性能对比 (Q4_K_M)

### Prefill (Prompt Processing)

| Tokens | GPU (t/s) | CPU (t/s) | GPU/CPU |
|--------|-----------|-----------|---------|
| 128    | 502       | 165       | 3.0x    |
| 512    | 988       | 462       | 2.1x    |
| 1024   | 856       | 433       | 2.0x    |
| 2048   | 798       | 402       | 2.0x    |
| 4096   | 705       | 356       | 2.0x    |

### Decode (Token Generation)

| Tokens | GPU (t/s) | CPU (t/s) | GPU/CPU |
|--------|-----------|-----------|---------|
| 128    | 88        | 10.3      | 8.5x    |
| 256    | 86        | 10.3      | 8.4x    |
| 512    | 84        | 10.2      | 8.2x    |

### 汇总

| 指标 | GPU (Vulkan) | CPU (32线程) | GPU/CPU |
|------|--------------|--------------|---------|
| **Prefill 平均** | 770 t/s | 364 t/s | 2.1x |
| **Decode 平均** | 86 t/s | 10 t/s | 8.4x |

---

## 详细测试数据

### Q4_K_M (17.28 GB) - GPU

| 测试类型 | Tokens | 速度 (t/s) | 标准差 |
|----------|--------|-----------|--------|
| Prefill | 128 | 498.38 | ±26.55 |
| Prefill | 512 | 1004.45 | ±14.11 |
| Prefill | 1024 | 905.54 | ±1.62 |
| Prefill | 2048 | 811.44 | ±7.49 |
| Decode | 128 | 85.99 | ±0.18 |
| Decode | 256 | 85.83 | ±0.02 |

### F16 (56.89 GB) - GPU

| 测试类型 | Tokens | 速度 (t/s) | 标准差 |
|----------|--------|-----------|--------|
| Prefill | 128 | 269.35 | ±8.84 |
| Prefill | 512 | 639.59 | ±0.19 |
| Prefill | 1024 | 613.12 | ±3.24 |
| Prefill | 2048 | 588.55 | ±7.52 |
| Decode | 128 | 21.90 | ±0.29 |
| Decode | 256 | 21.90 | ±0.44 |

---

## 性能可视化

### Prefill 速度曲线

```
Prefill 速度 vs Prompt 长度 (tokens/s)

1100 ┤
1000 ┤    ■ Q4_K_M (1004)
 900 ┤              ■ (906)
 800 ┤                      ■ (811)
 700 ┤
 600 ┤    ● F16 (640)  ● (613)  ● (589)
 500 ┤■ Q4_K_M (498)
 400 ┤
 300 ┤● F16 (269)
 200 ┤
     └────────────────────────────────────────────────────
       128        512       1024       2048    (tokens)
```

### Decode 速度对比

```
Decode 速度 (tokens/s)

Q4_K_M ████████████████████████████████████████████ 86 t/s
F16    ███████████ 22 t/s

                    ~4x 差距
```

---

## 适用场景推荐

| 场景 | 推荐模型 | 原因 |
|------|----------|------|
| **日常对话** | Q4_K_M | 速度快，响应及时 |
| **批量处理** | Q4_K_M | 吞吐量高 |
| **代码生成** | Q4_K_M | 通常足够准确 |
| **学术研究** | F16 | 需要最高精度 |
| **模型评估** | F16 | 避免量化误差 |
| **GPU 内存不足** | Q4_K_M + CPU | CPU 备选方案 |

---

## BF16 格式说明

原始 BF16 模型文件**无法直接在 Vulkan 后端运行**：
- Vulkan 设备信息: `bf16: 0` (不支持)
- 需要转换为 F16 格式才能使用

### 转换命令

```bash
# BF16 -> F16 转换
llama-quantize model-bf16.gguf model-f16.gguf F16

# BF16 -> Q4_K_M 量化 (更小更快)
llama-quantize model-bf16.gguf model-q4km.gguf Q4_K_M
```

---

## 内存架构说明

AMD Ryzen AI MAX+ 395 使用 **统一内存架构 (UMA)**：

| 内存类型 | 本机配置 | 说明 |
|---------|---------|------|
| GPU VRAM | 64 GB | 从系统内存分配 |
| GTT | 31 GB | 系统到 GPU 传输缓冲 |
| **GPU 总可用** | **~95 GB** | VRAM + GTT |
| 系统内存 | 62 GB | CPU 可用 |

**重要**: CPU 和 GPU 共享 128GB 物理内存，Vulkan 可访问约 95GB。

---

## 原始数据文件

| 测试 | 文件 |
|------|------|
| Q4_K_M GPU | `results/benchmark_gpu_20260113_102207.csv` |
| Q4_K_M CPU | `results/benchmark_cpu_20260113_103426.csv` |
| Q4_K_M (新) | `results/q4km_20260115_090831.csv` |
| F16 | `results/f16_20260115_090831.csv` |

---

## 测试日期

- 初次测试 (GPU vs CPU): 2026-01-13
- 更新 (Q4_K_M vs F16): 2026-01-15
